<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2026 ì§‘ë°˜ì°¬ ì†Œì›íƒ‘</title>
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&family=Noto+Sans+KR:wght@400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* === ìŠ¤íƒ€ì¼ ì •ì˜ === */
    :root { --primary-green: #2E7D32; --accent-gold: #FFD54F; --bg-warm: #F1F8E9; --text-main: #1B5E20; --card-bg: #FFFFFF; }
    body { background-color: var(--bg-warm); background-image: radial-gradient(#AED581 1px, transparent 1px); background-size: 20px 20px; font-family: 'Gowun Dodum', 'Noto Sans KR', sans-serif; margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; touch-action: none; user-select: none; -webkit-user-select: none; }
    canvas { z-index: 9999 !important; pointer-events: none; }
    
    /* ìƒë‹¨ ë­í‚¹ ë°” */
    #top-rank-bar { position: fixed; top: 0; left: 0; width: 100%; height: 80px; background: rgba(255, 255, 255, 0.95); box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 4000; display: flex; align-items: center; gap: 15px; border-bottom: 3px solid var(--primary-green); padding: 0 20px; overflow-x: auto; white-space: nowrap; }
    #top-rank-bar::-webkit-scrollbar { display: none; }
    .mini-card { background: white; border: 1px solid #C8E6C9; border-radius: 12px; padding: 8px 12px; width: 160px; height: 50px; display: inline-flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .mini-card.rank-1 { border: 2px solid var(--accent-gold); background: #FFFDE7; }
    .mini-rank { font-size: 1.2rem; font-weight: bold; color: #A5D6A7; }
    .mini-card.rank-1 .mini-rank { color: var(--accent-gold); }
    .mini-info { display: flex; flex-direction: column; justify-content: center; width: 100%; overflow: hidden; }
    .mini-name { font-weight: bold; color: #333; font-size: 0.8rem; }
    .mini-wish { font-size: 0.7rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* ë©”ì¸ ë·°í¬íŠ¸ & íŠ¸ë¦¬ */
    #viewport { width: 100%; height: 100%; position: relative; }
    #tree-container { position: absolute; left: 50%; top: 160px; display: flex; flex-direction: column; align-items: center; gap: 15px !important; padding-bottom: 600px; transition: transform 1.5s cubic-bezier(0.25, 1, 0.5, 1); transform-origin: center top; will-change: transform; }
    #tree-container.dragging { transition: none !important; }
    .pyramid-row { display: flex; justify-content: center; gap: 15px; width: 100%; align-items: flex-start; }

    /* ì†Œì› ì¹´ë“œ */
    .wish-card { background: var(--card-bg); border-radius: 16px; padding: 15px; width: 220px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 4px solid var(--primary-green); position: relative; flex-shrink: 0; display: flex; flex-direction: column; height: auto !important; min-height: 250px !important; pointer-events: auto; transition: transform 0.3s; }
    .wish-card.active-focus { border-color: var(--accent-gold); box-shadow: 0 0 0 6px rgba(255, 213, 79, 0.6), 0 30px 80px rgba(0,0,0,0.4); z-index: 100; transform: scale(1.05); }
    .wish-dept { font-size: 0.8rem; color: #66BB6A; font-weight: bold; margin-bottom: 4px; }
    .wish-name { font-size: 1rem; color: #333; font-weight: bold; }
    .wish-text { font-size: 1.2rem; font-weight: bold; margin: 10px 0; color: #1B5E20; line-height: 1.3; text-align: center; word-break: keep-all; }
    
    .top-comments { margin-top: 10px; border-top: 1px solid #eee; padding-top: 8px; display: flex; flex-direction: column; gap: 4px; margin-bottom: 10px; width: 100%; }
    .top-comment-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; background: #fafafa; padding: 6px; border-radius: 6px; color: #444; width: 100%; box-sizing: border-box; }
    .tc-content { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 5px; font-weight: 500; }
    .tc-like { color: #e02424; font-weight: bold; font-size: 0.75rem; flex-shrink: 0; }

    .btn-group { display: flex; justify-content: space-between; align-items: center; margin-top: auto; border-top: 1px dashed #eee; padding-top: 8px; }
    .rank-badge { font-size: 0.8rem; color: #999; font-weight: bold; }
    .action-buttons { display: flex; gap: 5px; }
    .like-btn, .cheer-btn { border-radius: 8px; padding: 0; width: 60px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 3px; font-weight: bold; font-size: 0.9rem; border: 1px solid #ddd; background: white; color: #555; transition: transform 0.1s; }
    .like-btn.liked { background: #FFEBEE; color: #D32F2F; border-color: #FFCDD2; }

    /* ì¶•í•˜ ì˜¤ë²„ë ˆì´ */
    #celebration-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(20, 50, 20, 0.95); z-index: 8000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
    #celebration-overlay.active { opacity: 1; pointer-events: auto; }
    .celebration-card { background: linear-gradient(135deg, #FFFDE7, #FFFFFF); border: 6px solid var(--accent-gold); border-radius: 30px; padding: 30px; width: 90%; max-width: 600px; text-align: center; box-shadow: 0 0 80px rgba(255, 213, 79, 0.8); transform: scale(0.8); transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    #celebration-overlay.active .celebration-card { transform: scale(1); animation: float 3s ease-in-out infinite; }
    .cel-icon { font-size: 4rem; margin-bottom: 10px; animation: pop 0.5s ease; }
    .cel-title { font-size: 1.6rem; color: var(--primary-green); font-weight: bold; margin-bottom: 20px; }
    .cel-main-box { background: #f5f5f5; padding: 12px; border-radius: 12px; margin-bottom: 15px; text-align: left; border: 1px solid #eee; opacity: 0.9; }
    .cel-label-small { font-size: 0.8rem; color: #888; display: block; margin-bottom: 3px; font-weight: bold; }
    .cel-text-small { font-size: 1.1rem; font-weight: bold; color: #555; line-height: 1.3; word-break: keep-all; }
    .cel-sub-box { background: #FFF3E0; padding: 20px; border-radius: 16px; margin-bottom: 15px; text-align: left; border: 2px solid #FFCC80; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .cel-label-large { font-size: 1rem; color: #E65100; display: block; margin-bottom: 8px; font-weight: bold; }
    .cel-text-large { font-size: 1.8rem; font-weight: 900; color: #333; line-height: 1.4; word-break: keep-all; }
    .cel-progress { width: 100%; height: 6px; background: #eee; margin-top: 20px; border-radius: 3px; overflow: hidden; }
    .cel-bar { width: 0%; height: 100%; background: var(--accent-gold); transition: width 4s linear; }
    #celebration-overlay.active .cel-bar { width: 100%; }

    /* ìƒì„¸ ë³´ê¸° (ìŠ¤í¬íŠ¸ë¼ì´íŠ¸) */
    #spotlight-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); z-index: 5000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.5s ease; }
    #spotlight-overlay.active { opacity: 1; pointer-events: auto; }
    .spotlight-container { display: flex; gap: 20px; max-width: 900px; width: 95%; height: 85vh; transform: scale(0.95); transition: transform 0.5s; }
    #spotlight-overlay.active .spotlight-container { transform: scale(1); }
    .spot-card { flex: 1; background: white; border-radius: 24px; padding: 25px; display: flex; flex-direction: column; overflow-y: auto; border-top: 8px solid var(--primary-green); }
    .spot-rank { font-size: 1rem; color: #999; font-weight: bold; }
    .spot-name { font-size: 1.5rem; font-weight: bold; color: #333; margin-bottom: 10px; }
    .spot-wish { font-size: 2.2rem; font-weight: bold; color: var(--text-main); margin: 15px 0; word-break: keep-all; line-height: 1.35; }
    .spot-skill-box { background: #E8F5E9; padding: 20px; border-radius: 16px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 5px; }
    .spot-skill-label { font-size: 0.95rem; color: #4CAF50; font-weight: bold; }
    .spot-skill-text { font-size: 1.3rem; color: #2E7D32; font-weight: bold; line-height: 1.4; }
    .spot-comments { flex: 0.9; background: #fff; border-radius: 24px; padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
    .spot-comments-header { font-size: 1.3rem; font-weight: bold; color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; display: flex; align-items: center; gap: 5px; }
    .spot-comment-list { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; }
    .comment-item { background: #fafafa; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; border: 1px solid #eee; }
    .comment-text { font-size: 1.2rem; color: #333; line-height: 1.5; font-weight: 500; }
    .comment-like-btn { border: 1px solid #eee; background: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; display: flex; align-items: center; gap: 3px; cursor: pointer; height: 36px; }
    .comment-like-btn.liked { background: #ffebee; color: #d32f2f; border-color: #ffcdd2; }
    .comment-form-container { background: #f1f8e9; padding: 15px; border-radius: 15px; margin-top: auto;}
    .comment-inputs { display: flex; gap: 5px; margin-bottom: 5px; }
    .comment-input { padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1.1rem; width: 100%; box-sizing: border-box; }
    .btn-submit-comment { width: 100%; padding: 12px; background: var(--primary-green); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
    .btn-close-spot { position: absolute; top: 10px; right: 10px; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-weight: bold; z-index: 10; font-size: 1.2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    
    body.overlay-open #ui-layer { display: none !important; }
    
    @media (max-width: 768px) {
      #tree-container { gap: 15px !important; padding-bottom: 300px; }
      .pyramid-row { gap: 10px !important; flex-wrap: wrap; }
      .wish-card { width: 92vw !important; max-width: 400px; min-height: auto !important; padding: 20px !important; }
      .wish-text { font-size: 1.5rem !important; margin: 15px 0; }
      .top-comment-item { font-size: 0.95rem !important; padding: 10px !important; }
      .spotlight-container { flex-direction: column; height: 95vh; width: 95%; top: 10px; display: block !important; height: 100% !important; overflow-y: auto; padding: 60px 10px 100px 10px; box-sizing: border-box; }
      .spot-card { margin-bottom: 20px; max-height: none !important; flex: none; }
      .spot-comments { flex: none; height: auto; }
      .spot-wish { font-size: 2.2rem !important; }
      .comment-text { font-size: 1.2rem !important; }
      .cel-text-large { font-size: 1.5rem !important; }
      .cel-text-small { font-size: 1rem !important; }
    }

    #ui-layer { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 6000; transition: opacity 0.3s; }
    #add-btn { background: var(--primary-green); color: white; border: none; border-radius: 50px; padding: 15px 45px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 8px 25px rgba(46, 125, 50, 0.5); }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 8000; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; }
    input, textarea { width: 100%; padding: 14px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 1rem; }
    .btn-main { width: 100%; padding: 14px; background: var(--primary-green); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer; }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    @keyframes pop { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
  </style>
</head>
<body>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxsgcLODsFfrQSV616mspKp4aTvaoc0uzS0kq1LQfb5WlS3qMvj4U_VqpWrqHU1qHdB/exec"; 
  </script>
  <div id="top-rank-bar"><div style="color:#999;">ë°ì´í„° ë¡œë”© ì¤‘...</div></div>
  <div id="viewport"><div id="tree-container"><h1 style="color:var(--text-main); font-size:3rem; margin-bottom:60px;">2026 ì§‘ë°˜ì°¬ ì†Œì›íƒ‘</h1><div id="cards-area"></div></div></div>
  
  <div id="celebration-overlay"><div class="celebration-card" id="cel-card-inner"><div class="cel-icon">ğŸ‰</div><div class="cel-title" id="cel-title"></div><div class="cel-main-box" id="box-wish"><span class="cel-label-small">ğŸ“Œ ì›ê¸€ ì†Œì›</span><div class="cel-text-small" id="cel-wish"></div></div><div class="cel-sub-box" id="box-comment"><span class="cel-label-large"></span><div class="cel-text-large" id="cel-comment"></div></div><div class="cel-progress"><div class="cel-bar"></div></div></div></div>
  <div id="spotlight-overlay"><button class="btn-close-spot" onclick="forceCloseSpotlight()">âœ•</button><div class="spotlight-container"><div class="spot-card"><div class="spot-info"><div class="spot-rank" id="spot-rank"></div><div class="spot-dept" id="spot-dept"></div><div class="spot-name" id="spot-name"></div></div><div class="spot-wish" id="spot-wish"></div><div class="spot-skill-box"><div class="spot-skill-label">ë…¸ë ¥</div><div class="spot-skill-text" id="spot-skill"></div></div><div style="margin-top:auto;display:flex;justify-content:space-between;"><button class="like-btn" id="spot-like-btn">â¤ï¸ 0</button><button onclick="openModal('edit')" style="background:none;border:none;text-decoration:underline;color:#999;padding:10px;">ìˆ˜ì •</button></div></div><div class="spot-comments"><div class="spot-comments-header"><span>ğŸ’Œ ì‘ì› ë©”ì‹œì§€</span><span style="font-size:0.9rem;color:#888;" id="spot-comment-count">(0)</span></div><div class="spot-comment-list" id="spot-comment-list"></div><div class="comment-form-container"><div class="comment-inputs"><input id="input-nick" placeholder="ë‹‰ë„¤ì„" class="comment-input" style="flex:0.4;"><input id="input-msg" placeholder="ì‘ì› í•œë§ˆë””" class="comment-input" style="flex:1;"></div><button class="btn-submit-comment" onclick="submitComment()">ì‘ì› ë“±ë¡</button></div><input type="hidden" id="spot-id-hidden"></div></div></div>
  <div id="ui-layer"><button id="add-btn" onclick="openModal('create')">ğŸ§§ ì†Œì› ë‹¬ê¸°</button></div>
  <div id="modal-form" class="modal-overlay"><div class="modal-content"><h2 style="color:var(--primary-green);margin-top:0;" id="modal-title">ì†Œì› ì‘ì„±</h2><form id="wish-form"><input type="hidden" name="id" id="form-id"><input type="hidden" name="mode" id="form-mode"><label>ì„±í•¨</label><input type="text" name="name" id="form-name" required><label>ë¶€ì„œ</label><input type="text" name="dept" id="form-dept" required><label>ìƒˆí•´ ì†Œë§ (20ì)</label><input type="text" name="wish" id="form-wish" maxlength="20" required><label>ë…¸ë ¥í•  ê²ƒ</label><input type="text" name="skill" id="form-skill"><button type="submit" class="btn-main">ì €ì¥í•˜ê¸°</button><button type="button" id="delete-btn" onclick="handleDelete()" style="display:none;width:100%;margin-top:10px;color:#d32f2f;border:1px solid #ef9a9a;background:#ffebee;padding:10px;border-radius:10px;cursor:pointer;font-weight:bold;">ì‚­ì œí•˜ê¸°</button><button type="button" onclick="closeModal('form')" style="width:100%;background:none;border:none;margin-top:10px;cursor:pointer;color:#888;">ë‹«ê¸°</button></form></div></div>
  <div id="success-modal" class="modal-overlay"><div class="modal-content" style="text-align:center;"><div style="font-size:3.5rem;margin-bottom:15px;">ğŸ®</div><h2 style="color:var(--primary-green);">ì†Œì› ë“±ë¡ ì™„ë£Œ!</h2><p style="color:#33691E;margin-bottom:25px;line-height:1.5;">2026ë…„,<br>ë‹¹ì‹ ì˜ ì†Œì›ì´ ê¼­ ì´ë¤„ì§ˆ ê±°ì˜ˆìš”!</p><button onclick="closeSuccessModal()" class="submit-btn">í™•ì¸</button></div></div>

  <script>
    // === API í†µì‹  í•¨ìˆ˜ (Vercelìš© fetch) ===
    async function apiCall(op, data = {}) {
      if(API_URL.includes("ì•„ì´ë””_ì…ë ¥")) { alert("index.html íŒŒì¼ì˜ API_URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!"); return; }
      const url = `${API_URL}?op=${op}`;
      try {
        if (op === 'read') {
          const res = await fetch(url);
          return await res.json();
        } else {
          // POST (CORS ìš°íšŒ: text/plain ì „ì†¡)
          const res = await fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify({ op, ...data }),
            headers: { 'Content-Type': 'text/plain' }
          });
          return await res.json();
        }
      } catch (err) {
        console.error("API Error:", err);
        throw err;
      }
    }

    // === ë³€ìˆ˜ ë° ì„¤ì • ===
    let likeSnapshot = {}; // { 'w-1': 10, 'c-999': 5 } í˜•íƒœ (ID: ì¢‹ì•„ìš”ìˆ˜)
    let isFirstLoad = true; // [ì¤‘ìš”] ì²« ë¡œë”© ì²´í¬ í”Œë˜ê·¸
    let currentWishes = [];
    let isPaused = false;
    let autoPlayTimer = null;
    let isTyping = false; 
    let containerX = 0, containerY = 0;
    let scale = 0.8;
    let initialScale = 0.8;
    let isDragging = false;
    let startX, startY;
    let dragMoveDistance = 0;
    let startDistance = 0;
    let currentFocusIndex = 0;
    let newCardIdToFocus = null;

    const audio = new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg');

    window.onload = () => {
      loadWishes();
      setInterval(loadWishes, 5000); 
      setInterval(updateLikeButtons, 1000);
      startAutoPlay();
      initInteractions();
      
      const inputs = document.querySelectorAll('input, textarea');
      inputs.forEach(input => {
        input.addEventListener('focus', () => { isTyping = true; isPaused = true; });
        input.addEventListener('blur', () => { isTyping = false; });
      });
    };

    function loadWishes() {
      if(isTyping) return;
      apiCall('read').then(render).catch(err => console.log(err));
    }

    function render(wishes) {
      if (!wishes) wishes = [];
      const newMaxId = Math.max(...wishes.map(w => w.id), 0);
      
      // [1] ìµœì´ˆ ë¡œë”© (First Load) - ë¬´ì¡°ê±´ ì¹¨ë¬µ
      if (isFirstLoad) {
        // ìŠ¤ëƒ…ìƒ·ë§Œ ì¡°ìš©íˆ ì €ì¥
        wishes.forEach(w => {
          likeSnapshot[`w-${w.id}`] = w.likes;
          w.comments.forEach(c => {
            likeSnapshot[`c-${c.commentId}`] = c.likes;
          });
        });
        window.lastMaxId = newMaxId;
        currentWishes = wishes;
        drawTopBar(wishes);
        drawCards(wishes);
        
        isFirstLoad = false; // í”Œë˜ê·¸ í•´ì œ
        return; // [í•µì‹¬] ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œ! (í­ì£½ ì½”ë“œ ì‹¤í–‰ ì•ˆí•¨)
      }

      // [2] ì´í›„ ë¡œë”© (Polling) - ë³€í™” ê°ì§€
      
      // 2-1. ì‹ ê·œ ì†Œì› ì²´í¬
      if (window.lastMaxId && newMaxId > window.lastMaxId) {
        const newWish = wishes.find(w => w.id === newMaxId);
        if(newWish) showCelebration('new_wish', { name: newWish.name, wish: newWish.wish });
      }
      window.lastMaxId = newMaxId;

      // 2-2. ì¢‹ì•„ìš” ë° ëŒ“ê¸€ ë³€í™” ì²´í¬ (High Water Mark)
      wishes.forEach(w => {
        // ì†Œì› ì¢‹ì•„ìš” ë¹„êµ
        const wKey = `w-${w.id}`;
        const currentLikes = w.likes;
        const storedLikes = likeSnapshot[wKey] || 0;

        if (currentLikes > storedLikes) {
            // ì„œë²„ ê°’ì´ ë‚´ ê¸°ì–µë³´ë‹¤ í´ ë•Œë§Œ í­ì£½ (ë‚´ê°€ ëˆ„ë¥¸ ê±´ ì´ë¯¸ ë°˜ì˜ë¨)
            showCelebration('card_like', { name: w.name, wish: w.wish });
            likeSnapshot[wKey] = currentLikes; 
        }

        // ëŒ“ê¸€ ë¹„êµ
        w.comments.forEach(c => {
           const cKey = `c-${c.commentId}`;
           const cLikes = c.likes;
           const cStored = likeSnapshot[cKey]; 

           if (cStored === undefined) {
               // ì™„ì „íˆ ìƒˆë¡œìš´ ëŒ“ê¸€ (IDê°€ ë‚´ ë©”ëª¨ë¦¬ì— ì—†ìŒ)
               showCelebration('new_comment', { name: w.name, wish: w.wish, comment: c.content });
               likeSnapshot[cKey] = cLikes;
           } else if (cLikes > cStored) {
               // ê¸°ì¡´ ëŒ“ê¸€ì˜ ì¢‹ì•„ìš” ìˆ˜ ì¦ê°€
               showCelebration('like_success', { name: w.name, wish: w.wish, comment: c.content });
               likeSnapshot[cKey] = cLikes;
           }
        });
      });

      currentWishes = wishes;
      drawTopBar(wishes);
      drawCards(wishes);

      // íŒì—… ì—´ë ¤ìˆìœ¼ë©´ ê°±ì‹ 
      const openId = document.getElementById('spot-id-hidden').value;
      if (openId && document.getElementById('spotlight-overlay').classList.contains('active')) {
        const target = wishes.find(w => w.id == openId);
        if (target) updateSpotlightContent(target, false);
      }
    }

    // UI ê·¸ë¦¬ê¸° í•¨ìˆ˜ë“¤
    function drawTopBar(wishes) {
      const topBar = document.getElementById('top-rank-bar');
      topBar.innerHTML = '';
      wishes.slice(0, 3).forEach((item, idx) => {
        topBar.innerHTML += `
          <div class="mini-card ${idx===0?'rank-1':''}">
            <div class="mini-rank">${idx+1}</div>
            <div class="mini-info">
              <div class="mini-name">${item.name} <span style="font-size:0.8rem; color:#d32f2f;">â¤ï¸ ${item.likes}</span></div>
              <div class="mini-wish">${item.wish}</div>
            </div>
          </div>`;
      });
    }

    function drawCards(wishes) {
      const container = document.getElementById('cards-area');
      container.innerHTML = '';
      
      if(containerX === 0 && containerY === 0 && wishes.length > 0) {
         const treeContainer = document.getElementById('tree-container');
         treeContainer.style.left = '50%';
         treeContainer.style.transform = `translate(-50%, 0) scale(${scale})`;
      }

      let idx = 0; 
      let rowCount = 1;
      while (idx < wishes.length) {
        const row = document.createElement('div');
        row.className = 'pyramid-row';
        for (let i = 0; i < rowCount; i++) {
          if (idx >= wishes.length) break;
          const w = wishes[idx];
          row.appendChild(createCardElement(w, idx + 1));
          idx++;
        }
        container.appendChild(row);
        rowCount++;
      }
    }

    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ë‚´ê°€ ëˆ„ë¥¼ ë•Œ)
    function handleLike(e, id) {
      e.stopPropagation();
      const key = `like_cooldown_${id}`;
      const expiry = localStorage.getItem(key);
      if (expiry && Date.now() < expiry) { alert("ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!"); return; }
      localStorage.setItem(key, Date.now() + 60000);
      
      const targetWish = currentWishes.find(w => w.id == id);
      if(targetWish) {
         targetWish.likes++;
         // [ì¤‘ìš”] ë‚´ ì¢‹ì•„ìš” ì„ ë°˜ì˜ (High Water Mark ì—…ë°ì´íŠ¸) -> í´ë§ ì‹œ ì¤‘ë³µ ë°©ì§€
         const wKey = `w-${id}`;
         const current = likeSnapshot[wKey] || 0;
         likeSnapshot[wKey] = Math.max(current, targetWish.likes); 
      }
      updateLikeButtons(); 
      apiCall('like', { id: id });
    }

    function handleCommentLike(e, commentId, commentContent, wishName, wishContent) {
      e.stopPropagation();
      const btn = e.currentTarget;
      let val = parseInt(btn.innerText.replace(/[^0-9]/g, '')) || 0;
      btn.innerText = `â¤ï¸ ${val + 1}`;
      btn.classList.add('liked');
      
      // [ì¤‘ìš”] ë‚´ ì¢‹ì•„ìš” ì„ ë°˜ì˜
      const cKey = `c-${commentId}`;
      const current = likeSnapshot[cKey] || 0;
      likeSnapshot[cKey] = Math.max(current, val + 1);

      isPaused = true; 
      // ë‚´ í™”ë©´ì—ì„œëŠ” ì¦‰ì‹œ ì¶•í•˜
      showCelebration('like_success', { name: wishName, wish: wishContent, comment: commentContent });
      apiCall('comment_like', { commentId: commentId });
    }

    function submitComment() {
      const id = document.getElementById('spot-id-hidden').value;
      const nick = document.getElementById('input-nick').value;
      const content = document.getElementById('input-msg').value;
      if(!nick || !content) { alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"); return; }
      
      const btn = document.querySelector('.btn-submit-comment');
      btn.innerText = "ì €ì¥ ì¤‘...";
      isPaused = true;
      
      apiCall('comment', { wishId: id, nick: nick, content: content }).then(() => {
        document.getElementById('input-msg').value = '';
        btn.innerText = "ì‘ì› ë“±ë¡";
        const item = currentWishes.find(w => w.id == id);
        // ë‚´ ëŒ“ê¸€ ì¦‰ì‹œ ì¶•í•˜
        showCelebration('new_comment', { name: item.name, wish: item.wish, comment: content });
      });
    }

    // ê¸°íƒ€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ (ê¸°ì¡´ ìœ ì§€)
    function showCelebration(type, data) {
      isPaused = true; if(autoPlayTimer) clearTimeout(autoPlayTimer);
      document.getElementById('spotlight-overlay').classList.remove('active');
      document.body.classList.remove('overlay-open');
      const overlay = document.getElementById('celebration-overlay');
      const title = document.getElementById('cel-title');
      const wishDiv = document.getElementById('cel-wish');
      const commentDiv = document.getElementById('cel-comment');
      const commentLabel = document.querySelector('#box-comment .cel-label-large');
      wishDiv.innerText = data.wish;
      if(type === 'new_wish') { title.innerText = "âœ¨ ìƒˆë¡œìš´ ì†Œì› ë“±ë¡!"; commentLabel.innerText = "ë©”ì‹œì§€"; commentDiv.innerText = `${data.name}ë‹˜ì´ ì†Œì›ì„ ì˜¬ë¦¬ì…¨ìŠµë‹ˆë‹¤!`; } 
      else if (type === 'new_comment') { title.innerText = "ğŸ’Œ ìƒˆë¡œìš´ ì‘ì› ë„ì°©!"; commentLabel.innerText = "ìƒˆë¡œìš´ ëŒ“ê¸€"; commentDiv.innerText = `"${data.comment}"`; } 
      else if (type === 'like_success') { title.innerText = "â¤ï¸ ì¢‹ì•„ìš” ì „ë‹¬ ì™„ë£Œ!"; commentLabel.innerText = "ì¸ê¸° ëŒ“ê¸€"; commentDiv.innerText = `"${data.comment}"`; } 
      else if (type === 'card_like') { title.innerText = "â¤ï¸ ì¸ê¸° ê¸‰ìƒìŠ¹!"; commentLabel.innerText = "ì•Œë¦¼"; commentDiv.innerText = `${data.name}ë‹˜ì˜ ì†Œì›ì„ ëˆ„êµ°ê°€ ì‘ì›í•©ë‹ˆë‹¤!`; }
      overlay.classList.add('active'); triggerFireworks(); audio.play().catch(e=>{});
      setTimeout(() => { overlay.classList.remove('active'); isPaused = false; startAutoPlay(); }, 4000);
    }

    function createCardElement(item, rank) {
      const div = document.createElement('div');
      const isTop = (rank === 1);
      div.className = `wish-card ${isTop ? 'card-top-rank' : ''}`;
      div.id = `card-id-${item.id}`;
      let topCommentsHtml = '';
      if(item.topComments && item.topComments.length > 0) {
        topCommentsHtml = `<div class="top-comments">`;
        item.topComments.forEach(c => { topCommentsHtml += `<div class="top-comment-item"><span class="tc-content"><b>${c.nickname}:</b> ${c.content}</span><span class="tc-like">â¤ï¸ ${c.likes}</span></div>`; });
        topCommentsHtml += `</div>`;
      }
      div.innerHTML = `<div style="flex:1;"><div class="wish-dept">${item.dept}</div><div class="wish-name">${item.name}</div><div class="wish-text">"${item.wish}"</div>${topCommentsHtml}</div><div class="btn-group"><div class="rank-badge">${rank}ìœ„</div><div class="action-buttons"><button class="like-btn" data-id="${item.id}" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()" onclick="handleLike(event, ${item.id})">â¤ï¸ ${item.likes}</button><button class="cheer-btn" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()" onclick="manualShowSpotlight(event, ${item.id})">ğŸ’¬ ${item.totalComments}</button></div></div>`;
      div.onclick = (e) => { if(!isDragging && dragMoveDistance < 5) manualShowSpotlight(e, item.id); };
      return div;
    }

    function updateSpotlightContent(item, resetScroll) {
      document.getElementById('spot-id-hidden').value = item.id;
      document.getElementById('spot-rank').innerText = `${currentWishes.indexOf(item) + 1}ìœ„`;
      document.getElementById('spot-dept').innerText = item.dept;
      document.getElementById('spot-name').innerText = item.name;
      document.getElementById('spot-wish').innerText = `"${item.wish}"`;
      document.getElementById('spot-skill').innerText = item.skill || '-';
      const likeBtn = document.getElementById('spot-like-btn');
      likeBtn.innerHTML = `â¤ï¸ ${item.likes}`;
      likeBtn.onclick = (e) => handleLike(e, item.id);
      document.getElementById('spot-comment-count').innerText = `(${item.totalComments})`;
      const list = document.getElementById('spot-comment-list');
      list.innerHTML = '';
      if(item.comments.length === 0) { list.innerHTML = '<div style="text-align:center; color:#ccc; padding:30px;">ì²« ì‘ì›ì„ ë‚¨ê²¨ì£¼ì„¸ìš”!</div>'; } 
      else { item.comments.forEach(c => { list.innerHTML += `<div class="comment-item"><div class="comment-content-box"><span class="comment-meta">${c.nickname}</span><div class="comment-text">${c.content}</div></div><button class="comment-like-btn" onclick="handleCommentLike(event, '${c.commentId}', '${c.content}', '${item.name}', '${item.wish}')">â¤ï¸ ${c.likes}</button></div>`; }); }
      if(resetScroll) list.scrollTop = 0;
    }

    function updateLikeButtons() { document.querySelectorAll('.like-btn').forEach(btn => { const id = btn.getAttribute('data-id'); const expiry = localStorage.getItem(`like_cooldown_${id}`); const item = currentWishes.find(w => w.id == id); const currentLikes = item ? item.likes : 0; if (expiry && Date.now() < expiry) { const left = Math.ceil((expiry - Date.now()) / 1000); btn.innerHTML = `â¤ï¸ ${currentLikes} <span style="font-size:0.8em; color:#999;">(${left}s)</span>`; btn.classList.add('cooldown'); } else { btn.innerText = `â¤ï¸ ${currentLikes}`; btn.classList.remove('cooldown'); } }); const spotBtn = document.getElementById('spot-like-btn'); if(spotBtn) { const id = document.getElementById('spot-id-hidden').value; const item = currentWishes.find(w => w.id == id); if(item) { const expiry = localStorage.getItem(`like_cooldown_${id}`); if (expiry && Date.now() < expiry) { spotBtn.innerHTML = `â¤ï¸ ${item.likes} <span style="font-size:0.8em">(${left}s)</span>`; spotBtn.disabled = true; } else { spotBtn.innerText = `â¤ï¸ ${item.likes}`; spotBtn.disabled = false; } } } }
    function manualShowSpotlight(e, id) { e.stopPropagation(); isPaused = true; if(autoPlayTimer) clearTimeout(autoPlayTimer); setTimeout(() => { if(!isTyping) isPaused = false; startAutoPlay(); }, 10000); const item = currentWishes.find(w => w.id == id); if(item) showSpotlight(item); }
    function showSpotlight(item) { const targetCard = document.getElementById(`card-id-${item.id}`); if(targetCard) { targetCard.classList.add('active-focus'); const cardX = targetCard.offsetLeft + (targetCard.offsetWidth / 2); const cardY = targetCard.offsetTop + (targetCard.offsetHeight / 2); let scaleTarget = 1.0; if(window.innerWidth < 768) scaleTarget = 0.9; const viewportCenterY = window.innerHeight * 0.4; const startYPoint = window.innerHeight * 0.2; containerX = -cardX; containerY = ((viewportCenterY - startYPoint) / scaleTarget) - cardY; scale = scaleTarget; applyTransform(); } setTimeout(() => { const overlay = document.getElementById('spotlight-overlay'); updateSpotlightContent(item, true); document.body.classList.add('overlay-open'); overlay.classList.add('active'); }, 1000); }
    function forceCloseSpotlight() { document.getElementById('spotlight-overlay').classList.remove('active'); document.body.classList.remove('overlay-open'); document.querySelectorAll('.active-focus').forEach(c => c.classList.remove('active-focus')); scale = 0.8; containerX = 0; containerY = 0; applyTransform(); setTimeout(() => { if(!isTyping) { isPaused = false; startAutoPlay(); } }, 3000); }
    function startAutoPlay() { if(autoPlayTimer) clearTimeout(autoPlayTimer); autoPlayTimer = setTimeout(() => { if (isPaused || isTyping || isDragging || currentWishes.length === 0) { startAutoPlay(); return; } document.getElementById('spotlight-overlay').classList.remove('active'); document.body.classList.remove('overlay-open'); document.querySelectorAll('.active-focus').forEach(c => c.classList.remove('active-focus')); let target = null; if (newCardIdToFocus) { target = currentWishes.find(w => w.id == newCardIdToFocus); newCardIdToFocus = null; } if (!target) { if (currentFocusIndex >= currentWishes.length) currentFocusIndex = 0; target = currentWishes[currentFocusIndex]; currentFocusIndex++; } if (target) { showSpotlight(target); setTimeout(() => { startAutoPlay(); }, 5000); } else { startAutoPlay(); } }, 2000); }
    function triggerFireworks() { const duration = 2000; const end = Date.now() + duration; (function frame() { confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } }); confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } }); if (Date.now() < end) requestAnimationFrame(frame); }()); }
    function initInteractions() { const viewport = document.getElementById('viewport'); viewport.addEventListener('mousedown', startDrag); window.addEventListener('mousemove', drag); window.addEventListener('mouseup', endDrag); viewport.addEventListener('touchstart', handleTouchStart, {passive: false}); window.addEventListener('touchmove', handleTouchMove, {passive: false}); window.addEventListener('touchend', endDrag); }
    function handleTouchStart(e) { if (['BUTTON','INPUT','TEXTAREA'].includes(e.target.tagName)) return; if (e.touches.length === 2) { isPaused = true; if(autoPlayTimer) clearTimeout(autoPlayTimer); const t1 = e.touches[0]; const t2 = e.touches[1]; startDistance = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY); initialScale = scale; } else if (e.touches.length === 1) { startDrag(e); } }
    function handleTouchMove(e) { if (e.touches.length === 2) { e.preventDefault(); const t1 = e.touches[0]; const t2 = e.touches[1]; const dist = Math.hypot(t1.clientX - t2.clientX, t1.clientY - t2.clientY); if (startDistance > 0) { const delta = dist / startDistance; scale = Math.min(Math.max(initialScale * delta, 0.4), 2.5); applyTransform(); } } else if (e.touches.length === 1) { if(isDragging) { e.preventDefault(); drag(e); } } }
    function startDrag(e) { if (['BUTTON','INPUT','TEXTAREA'].includes(e.target.tagName)) return; isPaused = true; if(autoPlayTimer) clearTimeout(autoPlayTimer); isDragging = true; dragMoveDistance = 0; document.getElementById('tree-container').classList.add('dragging'); const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX; const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY; startX = clientX; startY = clientY; const container = document.getElementById('tree-container'); const style = window.getComputedStyle(container); const matrix = new WebKitCSSMatrix(style.transform); if (style.transform !== 'none') { initialX = matrix.m41; initialY = matrix.m42; if(containerX === 0 && containerY === 0) { containerX = initialX; containerY = initialY; } } else { initialX = containerX; initialY = containerY; } }
    function drag(e) { if (!isDragging) return; const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX; const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY; const dx = clientX - startX; const dy = clientY - startY; dragMoveDistance = Math.sqrt(dx*dx + dy*dy); containerX = initialX + dx; containerY = initialY + dy; applyTransform(); }
    function endDrag() { if (isDragging) { isDragging = false; document.getElementById('tree-container').classList.remove('dragging'); setTimeout(() => { if(!isTyping) { isPaused = false; startAutoPlay(); } }, 10000); } startDistance = 0; }
    function applyTransform() { document.getElementById('tree-container').style.transform = `translate(${containerX}px, ${containerY}px) scale(${scale})`; }
    
    // ëª¨ë‹¬ ê´€ë ¨
    document.getElementById('wish-form').onsubmit = function(e) { e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); btn.innerText = "ì €ì¥ ì¤‘..."; btn.disabled = true; const formData = { id: document.getElementById('form-id').value, name: document.getElementById('form-name').value, dept: document.getElementById('form-dept').value, wish: document.getElementById('form-wish').value, skill: document.getElementById('form-skill').value }; const mode = document.getElementById('form-mode').value; const op = mode === 'create' ? 'create' : 'update'; apiCall(op, { data: formData }).then(() => { closeModal(); btn.innerText = "ì €ì¥í•˜ê¸°"; btn.disabled = false; loadWishes(); if(mode==='create') showCelebration('new_wish', {name:formData.name, wish:formData.wish}); }); };
    function openModal(mode, id = null) { isPaused = true; document.getElementById('modal-form').style.display = 'flex'; const form = document.getElementById('wish-form'); if(mode === 'create') { document.getElementById('modal-title').innerText = "ì†Œì› ì‘ì„±"; form.reset(); document.getElementById('form-mode').value = 'create'; document.getElementById('delete-btn').style.display = 'none'; } else { document.getElementById('modal-title').innerText = "ì†Œì› ìˆ˜ì •"; const currentId = document.getElementById('spot-id-hidden').value; const item = currentWishes.find(w => w.id == currentId); if(item) { document.getElementById('form-id').value = item.id; document.getElementById('form-name').value = item.name; document.getElementById('form-dept').value = item.dept; document.getElementById('form-wish').value = item.wish; document.getElementById('form-skill').value = item.skill; document.getElementById('form-mode').value = 'edit'; document.getElementById('delete-btn').style.display = 'block'; } } }
    function closeModal() { document.getElementById('modal-form').style.display = 'none'; setTimeout(() => { isPaused = false; startAutoPlay(); }, 2000); }
    function closeSuccessModal() { document.getElementById('success-modal').style.display = 'none'; loadWishes(); }
    function handleDelete() { if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; const id = document.getElementById('form-id').value; apiCall('delete', { id: id }).then(() => { closeModal(); forceCloseSpotlight(); loadWishes(); }); }
  </script>
</body>
</html>